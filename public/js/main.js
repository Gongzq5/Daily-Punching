var awardsAddress = "0x2a41d7aaa719bee2e43c9dac1c8876728fe9a703";

var awardsData = '608060405234801561001057600080fd5b506104b3806100206000396000f3fe60806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806336e4784d146100515780639fbd5bc9146100a2575b600080fd5b34801561005d57600080fd5b506100a06004803603602081101561007457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610139565b005b3480156100ae57600080fd5b506100f1600480360360208110156100c557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506102e1565b604051808463ffffffff1663ffffffff1681526020018363ffffffff1663ffffffff1681526020018263ffffffff1663ffffffff168152602001935050505060405180910390f35b60006101436103e9565b90506005600a8281151561015357fe5b0610156101d55760016000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff1602179055506102dd565b6008600a828115156101e357fe5b0610156102655760016000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160048282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff1602179055506102dc565b60016000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160088282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908363ffffffff1602179055505b5b5050565b60008060008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900463ffffffff166000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160049054906101000a900463ffffffff166000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160089054906101000a900463ffffffff169250925092509193909250565b6000804260405160200180828152602001915050604051602081830303815290604052805190602001206001900433604051602001808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014019150506040516020818303038152906040528051906020012060019004189050809150509056fea165627a7a7230582029385b525bf064be6144ef9bba10514f15795993efe5a990e67eb4ad00955d2c0029';
var missionData = '0x608060405234801561001057600080fd5b5060405161085f38038061085f8339810180604052606081101561003357600080fd5b81019080805164010000000081111561004b57600080fd5b8281019050602081018481111561006157600080fd5b815185600182028301116401000000008211171561007e57600080fd5b5050929190602001805164010000000081111561009a57600080fd5b828101905060208101848111156100b057600080fd5b81518560018202830111640100000000821117156100cd57600080fd5b50509291906020018051906020019092919050505082600090805190602001906100f89291906101bc565b50816001908051906020019061010f9291906101bc565b5080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050610261565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101fd57805160ff191683800117855561022b565b8280016001018555821561022b579182015b8281111561022a57825182559160200191906001019061020f565b5b509050610238919061023c565b5090565b61025e91905b8082111561025a576000816000905550600101610242565b5090565b90565b6105ef806102706000396000f3fe60806040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806325d40d56146100725780635a9b0b89146100db578063682bb813146101d7578063bf96ae63146101ee578063fc2b8cc314610205575b600080fd5b34801561007e57600080fd5b506100c16004803603602081101561009557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061021c565b604051808215151515815260200191505060405180910390f35b3480156100e757600080fd5b506100f061023c565b604051808060200180602001838103835285818151815260200191508051906020019080838360005b83811015610134578082015181840152602081019050610119565b50505050905090810190601f1680156101615780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b8381101561019a57808201518184015260208101905061017f565b50505050905090810190601f1680156101c75780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156101e357600080fd5b506101ec610383565b005b3480156101fa57600080fd5b506102036104b9565b005b34801561021157600080fd5b5061021a610513565b005b60046020528060005260406000206000915054906101000a900460ff1681565b60608060006001818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102d85780601f106102ad576101008083540402835291602001916102d8565b820191906000526020600020905b8154815290600101906020018083116102bb57829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103745780601f1061034957610100808354040283529160200191610374565b820191906000526020600020905b81548152906001019060200180831161035757829003601f168201915b50505050509050915091509091565b60011515600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415156103e257600080fd5b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166336e4784d336040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050600060405180830381600087803b15801561049f57600080fd5b505af11580156104b3573d6000803e3d6000fd5b50505050565b6001600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550565b60011515600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514151561057257600080fd5b600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff021916905556fea165627a7a72305820a32decd2a86d12f0751d06054af93dc52782966d18c6d1d922cfe88c5af7256d0029';
var missionABI = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"signedUsers","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getInfo","outputs":[{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"punch","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"signUp","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"quit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"sourceName","type":"string"},{"name":"sourceDescription","type":"string"},{"name":"_addr","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];
var awardsABI = [{"constant":false,"inputs":[{"name":"user","type":"address"}],"name":"sendAwardTo","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"retriveAwards","outputs":[{"name":"","type":"uint32"},{"name":"","type":"uint32"},{"name":"","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"}];

var web3, awards;
var currUser;
var mission = undefined;

$(function($) {
    // init 
    $("#loginContent").show();
    $("#missionContent").hide();
    $("#punchContent").hide();
    $("#awardsContent").hide();
    $(".alert").hide();

    // get web3
    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
        console.log("Show web3");
    } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:8545"));
        console.log("New provider");
    }

    // get awards contract
    awards = new web3.eth.Contract(awardsABI, awardsAddress);

    if (typeof awards !== 'undefined') {
        console.log('Awards is not empty');
    } else {
        console.log('Awards is empty');
    }

    // Dropdown menu
    $(".sidebar-dropdown > a").click(function () {
        $(".sidebar-submenu").slideUp(200);
        if ($(this).parent().hasClass("active")) {
            $(".sidebar-dropdown").removeClass("active");
            $(this).parent().removeClass("active");
        } else {
            $(".sidebar-dropdown").removeClass("active");
            $(this).next(".sidebar-submenu").slideDown(200);
            $(this).parent().addClass("active");
        }
    });

    $("#switchUserButton").click(function() {
        $("#loginContent").show();
        $("#missionContent").hide();
        $("#punchContent").hide();
        $("#awardsContent").hide();
        $(".alert").hide();
    });
    
    $("#loginButton").click(function() {
        var tmpUser = $("#username").val();
        web3.eth.personal.unlockAccount(tmpUser, $("#password").val())
        .then((val) => {
            console.log(val);
            if (val == true) {
                currUser = tmpUser;
                showLoginAlert('s', "登陆成功，请等待跳转");
                $("#usernameContent").text(currUser);
                setTimeout($("#punchPageButton").click(), 3000);
            } else {
                showLoginAlert('f', "登陆失败，请重新输入");
            }
        })
    });

    // close sidebar 
    $("#close-sidebar").click(function () {
        $(".page-wrapper").removeClass("toggled");
    });

    //show sidebar
    $("#show-sidebar").click(function () {
        $(".page-wrapper").addClass("toggled");
    });

    $("#establishPageButton").click(function() {
        if (typeof currUser == 'undefined') {
            showLoginAlert('f', "请先登录");
            return;
        }
        $("#loginContent").hide();
        $("#punchContent").hide();
        $("#awardsContent").hide();
        $("#missionContent").show();
    });
    
    $("#awardsPageButton").click(function() {
        if (typeof currUser == 'undefined') {
            showLoginAlert('f', "请先登录");
            return;
        }
        updateAwardsInfo();
        $("#loginContent").hide();
        $("#missionContent").hide();
        $("#punchContent").hide();
        $("#awardsContent").show();
    });
    
    $("#punchPageButton").click(function() {
        if (typeof currUser == 'undefined') {
            showLoginAlert('f', "请先登录");
            return;
        }
        $("#loginContent").hide();
        $("#missionContent").hide();
        $("#awardsContent").hide();
        $("#punchContent").show();
    });

    $("#missionEstablishButton").click(establishMission);
    $("#punchSearchButton").click(searchMission);
    $("#punchButton").click(punchMisson);
    $("#quitButton").click(quitMission);
    $("#signUpButton").click(signUpMission);
});

function establishMission() {
    let missionTitle = $("#establishMissionName").val();
    let missionDescription = $("#establishMissionDescription").val();
    console.log(missionTitle + " " + missionDescription);
    console.log(currUser);

    if (missionTitle.length == 0 || missionDescription.length == 0) {
        showEstablishAlert('f', "Misson's name and description cannot miss both.");
    } else {
        showEstablishAlert('s', "Mission is establishing ... Please wait in patient");
        $("#missionEstablishButton").addClass("disabled");
        web3.eth.personal.unlockAccount(currUser, "");
        console.log(missionTitle, " ", missionDescription, " ", typeof(missionTitle))
        let missionContract = new web3.eth.Contract(missionABI);
        let newMission = missionContract.deploy({
            data: missionData,
            arguments: [missionTitle, missionDescription, awardsAddress]
        })
        .send({
            from: currUser, 
            gas: '4700000',
            gasPrice: '30000000000000'
        }, function(err, transactionHash) {
            if (!err) console.log(transactionHash);
            else console.log(err);
        })
        .on('error', function(error){ 
            showEstablishAlert('f', "发布任务失败，没有成功存入链中。");
            $("#missionEstablishButton").removeClass("disabled");
        })
        .on('transactionHash', function(transactionHash){ 
            console.log('transactionHash', transactionHash);
        })
        .on('receipt', function(receipt){
           console.log(receipt.contractAddress) // contains the new contract address
        })
        .then(function(newContractInstance){
            console.log(newContractInstance.options.address) // instance with the new contract address
            console.log('Contract mined! address: ' + newContractInstance.options.address);
            showEstablishAlert('s', "发布任务成功，已将此信息存入链中！请记住您发布的任务的标识：" + newContractInstance.options.address + "。此信息只出现一次，请妥善保存。");
            $("#missionEstablishButton").removeClass("disabled");
        });
        console.log(newMission);
    }
}

async function searchMission() {
    addr = $("#missionAddress").val();
    mission = new web3.eth.Contract(missionABI, addr);
    showPunchAlert('s', "请稍等，正在查询");
    var name = mission.methods.getInfo().call({from: currUser})
    .then((val)=>{
        missionTitle = val[0];
        missionDescription = val[1];
        $("#missionAddress").val("");
        $("#punchTitle").text(missionTitle);
        $("#punchDescription").text(missionDescription);
        $("#punchAlert").hide();
    });
}

async function signUpMission() {
    if (typeof mission == 'undefined') {
        showPunchAlert('s', "请先查询");
    } else {
        mission.methods.signUp().send({from: currUser})
        .on('error', function (err) {
            console.log(err);
            showPunchAlert("f", "失败，请稍后再试");
        })
        .then((val) => {
            showPunchAlert('s', "叮~成功报名！");
        });
    }
}

function punchMisson() {
    mission.methods.punch().send({from: currUser})
    .on('error', function (err) {
        console.log(err);
        showPunchAlert("f", "失败，请稍后再试");
    })
    .then((val) => {
        console.log(val);
        if (val.status == "0x0") {
            showPunchAlert("f", "失败，请先报名");
        } else {
            showPunchAlert('s', "成功打卡");
        }
    });
}

async function quitMission() {
    mission.methods.quit().send({from: currUser})
    .on('error', (err) => {
        console.log(err);
        showPunchAlert("f", "退出失败，请稍后再试");
    })
    .then((val) => {
        console.log(val);
        if (val.status == "0x0") {
            showPunchAlert("f", "失败，您已经不在这个任务中了哦");
        } else {
            showPunchAlert("s", "成功退出任务~");
        }
    })
}

async function updateAwardsInfo() {
    awards.methods.retriveAwards(currUser).call({from: currUser})
    .then((val) => {
        $("#treeCounts").text(val[0]);
        $("#flowerCounts").text(val[1]);
        $("#dogCounts").text(val[2]);
    });
}


function showLoginAlert(type, msg) {
    if (type == 's') {
        $("#loginAlert")
            .removeClass("alert-danger")
            .addClass("alert-success")
            .text(msg)
            .show();
    } else {
        $("#loginAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text(msg)
            .show();
    }
}


function showPunchAlert(type, msg) {
    if (type == 's') {
        $("#punchAlert")
            .removeClass("alert-danger")
            .addClass("alert-success")
            .text(msg)
            .show();
    } else {
        $("#punchAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text(msg)
            .show();
    }
}

function showQuitAlert(type) {
    if (type == 's') {
        $("#punchAlert")
            .removeClass("alert-danger")
            .addClass("alert-success")
            .text("成功退出任务")
            .show();
    } else {
        $("#punchAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text("退出失败，请稍后再试")
            .show();
    }
}

function showEstablishAlert(type, msg) {
    if (type == 's') {
        $("#establishAlert")
            .removeClass("alert-danger")
            .addClass("alert-success")
            .text(msg)
            .show();
    } else {
        $("#establishAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text(msg)
            .show();
    }
}
